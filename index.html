<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта монтажа — подсветка домов (Leaflet/OSM)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    #app { display: grid; grid-template-columns: 360px 1fr; height: 100%; }
    #sidebar { padding: 14px; border-right: 1px solid #eee; overflow: auto; }
    #map { width: 100%; height: 100%; }
    .panel { background: #fafafa; border: 1px solid #eaeaea; border-radius: 12px; padding: 12px; margin-bottom: 12px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row input, .row button, textarea { font-size: 14px; }
    textarea { width: 100%; min-height: 120px; resize: vertical; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    .legend { display: grid; grid-template-columns: 1fr auto; gap: 6px 10px; font-size: 13px; }
    .swatch { width: 18px; height: 18px; border-radius: 4px; border: 1px solid rgba(0,0,0,.15); }
    .item { padding: 8px 10px; border-radius: 10px; border: 1px dashed #ddd; margin-bottom: 6px; cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .pill { padding: 2px 6px; border-radius: 999px; font-size: 12px; background: #f1f5f9; border: 1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="panel">
      <div style="font-weight:700;">Карта монтажа — Leaflet/OSM</div>
      <div class="muted">Вставь адреса → «Построить». Понимает и 6-колоночный формат.</div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Адреса</div>
      <textarea id="addrInput" placeholder="Форматы:
• Адрес[TAB]Статус[TAB]#Цвет
• ID  ID2  Город  Улица  Дом  Подъезд  (через пробелы/табы). Статус = 'Подъезд N'."></textarea>
      <div class="row" style="margin-top:8px;">
        <button id="btnBuild">Построить</button>
        <button id="btnClear">Очистить</button>
        <button id="btnFit">Показать все</button>
      </div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Легенда статусов</div>
      <div id="legend" class="legend"></div>
    </div>

    <div class="panel">
      <div style="font-weight:600; margin-bottom:6px;">Найденные точки</div>
      <div id="list"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script>
(function(){
  // ===== Карта Leaflet (без ключей) =====
  const map = L.map('map').setView([51.533, 46.033], 12); // Саратов по умолчанию
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const $ = (s)=>document.querySelector(s);
  const state = {
    layers: [],
    bounds: L.latLngBounds()
  };

  function clearAll(){
    state.layers.forEach(l => map.removeLayer(l));
    state.layers = [];
    state.bounds = L.latLngBounds();
    $('#list').innerHTML = '';
  }

  function addListItem(item){
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px;align-items:center;">
      <div style="font-weight:600">${escapeHtml(item.address)}</div>
      ${item.status?`<span class='pill' style='border:1px solid ${item.color||'#ddd'}'>${escapeHtml(item.status)}</span>`:''}
    </div><div class='muted'>${item.lat&&item.lon?`${item.lat.toFixed(6)}, ${item.lon.toFixed(6)}`:'—'}</div>`;
    el.addEventListener('click',()=>{ if(item.lat&&item.lon){ map.setView([item.lat,item.lon], 17); } });
    $('#list').appendChild(el);
  }
  function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // ===== Цвета/легенда =====
  const statusColor = new Map();
  function hash(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }
  function ensureColor(item){
    if(item.color) return item.color; // передан #hex/hsl
    if(!item.status) return '#7c3aed';
    if(statusColor.has(item.status)) return statusColor.get(item.status);
    const h=Math.abs(hash(item.status))%360;
    const c=`hsl(${h} 90% 45%)`;
    statusColor.set(item.status,c);
    return c;
  }
  function addLegendRow(s,c){ const host=$('#legend'); const t=document.createElement('div'); t.textContent=s||'(без статуса)'; const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=c||'#7c3aed'; host.appendChild(t); host.appendChild(sw); }
  function rebuildLegend(){
    const host=$('#legend'); host.innerHTML='';
    const arr=Array.from(statusColor.entries());
    if(!arr.length){ addLegendRow('Адреса','#7c3aed'); return; }
    arr.forEach(([s,c])=>addLegendRow(s,c));
  }

  // ===== Парсер ввода =====
  function parseInput(text){
    const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const out=[];
    for(const line of lines){
      // 6-колонок: ID ID2 City Street House Entrance
      const m6=/^(\S+)\s+(\S+)\s+(\S+)\s+(.+?)\s+(\S+)\s+(\S+)$/.exec(line);
      if(m6){ const city=m6[3], street=m6[4], house=m6[5], entr=m6[6]; out.push({ address:`${city}, ${street} ${house}`, status:`Подъезд ${entr}`, color:'' }); continue; }
      // Табами: Адрес \t Статус \t Цвет
      const tab=line.split(/\t/);
      if(tab.length>=1){ out.push({ address:tab[0]?.trim(), status:tab[1]?.trim()||'', color:(tab[2]?.trim()||'').toLowerCase() }); continue; }
    }
    return out;
  }

  // ===== Геокодер: Photon (OSM), без ключей =====
  // Документация: https://photon.komoot.io/
  async function geocode(address){
    const url = new URL('https://photon.komoot.io/api/');
    url.searchParams.set('q', address);
    url.searchParams.set('limit', '1');
    const r = await fetch(url.toString(), { headers: { 'Accept': 'application/json' } });
    if(!r.ok) throw new Error('Photon error: '+r.status);
    const j = await r.json();
    const f = j?.features?.[0];
    if(!f) return null;
    const point = f.geometry?.type==='Point' ? f.geometry.coordinates : null; // [lon, lat]
    // photon чаще отдаёт только точку. Если когда-то попадётся Polygon/MultiPolygon — тоже поддержим:
    let polygon = null;
    if (f.geometry?.type === 'Polygon') polygon = f.geometry.coordinates[0];
    if (f.geometry?.type === 'MultiPolygon') polygon = f.geometry.coordinates[0][0];
    return { point, polygon };
  }

  // ===== Геометрия: квадрат вокруг точки (~30×30 м) =====
  function squareAround([lon, lat], meters = 30){
    const dLat = (meters / 111320);               // ~метры в градус широты
    const dLon = (meters / (40075000 * Math.cos(lat*Math.PI/180) / 360)); // метры в градус долготы
    return [
      [lat+dLat, lon-dLon],
      [lat+dLat, lon+dLon],
      [lat-dLat, lon+dLon],
      [lat-dLat, lon-dLon]
    ];
  }

  function withAlpha(color, a){
    if(/^#([0-9a-f]{6})$/i.test(color)){
      const r=parseInt(color.slice(1,3),16), g=parseInt(color.slice(3,5),16), b=parseInt(color.slice(5,7),16);
      return `rgba(${r},${g},${b},${a})`;
    }
    if(/^hsl\(/i.test(color)){
      return color.replace(/^hsl/i,'hsla').replace(/\)$/,`, ${a})`);
    }
    return color;
  }

  async function build(){
    clearAll();
    const items = parseInput(document.getElementById('addrInput').value);
    for(const item of items){
      const color = ensureColor(item);
      try{
        const res = await geocode(item.address);
        if(!res){ addListItem(item); continue; }

        let latlng = null;
        if(res.polygon){
          // координаты идут как [lon,lat] — преобразуем
          const ringLatLng = res.polygon.map(([lon,lat])=>[lat,lon]);
          const poly = L.polygon(ringLatLng, { color: color, weight: 2, fillColor: withAlpha(color,0.35) }).addTo(map);
          state.layers.push(poly);
          latlng = poly.getBounds().getCenter();
        } else if(res.point){
          const [lon,lat] = res.point;
          const sq = squareAround([lon,lat], 30).map(([la,lo])=>[la,lo]); // уже [lat,lon]
          const poly = L.polygon(sq, { color: color, weight: 2, fillColor: withAlpha(color,0.35) }).addTo(map);
          const dot = L.circleMarker([lat,lon], { radius: 4, color: '#fff', weight: 2, fillColor: color, fillOpacity: 1 }).addTo(map);
          state.layers.push(poly, dot);
          latlng = [lat,lon];
        }

        if(latlng){
          item.lat = latlng[0]; item.lon = latlng[1];
          state.bounds.extend(latlng);
        }
        addListItem(item);
        await new Promise(r=>setTimeout(r,120)); // мягкий rate limit
      }catch(e){
        console.warn('Ошибка геокодинга', item.address, e);
        addListItem(item);
      }
    }
    rebuildLegend();
    if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.2));
  }

  document.getElementById('btnBuild').addEventListener('click', build);
  document.getElementById('btnClear').addEventListener('click', ()=>{ document.getElementById('addrInput').value=''; clearAll(); rebuildLegend(); });
  document.getElementById('btnFit').addEventListener('click', ()=>{ if(state.bounds.isValid()) map.fitBounds(state.bounds.pad(0.2)); });

  // демо-ввод
  document.getElementById('addrInput').value = [
    '12\t970\tСаратов\t1-я Беговая\t13\t4',
    '20\t772\tСаратов\t1-й Кавказский\t10\t4'
  ].join('\n');
})();
</script>
</body>
</html>
